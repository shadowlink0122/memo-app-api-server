name: CI/CD Pipeline

# ãƒ–ãƒ©ãƒ³ãƒæˆ¦ç•¥:
# - å…¨ã‚¸ãƒ§ãƒ–ï¼ˆãƒ†ã‚¹ãƒˆãƒ»ãƒ“ãƒ«ãƒ‰ãƒ»ãƒªãƒ³ãƒˆãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ãƒ»E2Eï¼‰: å…¨ãƒ–ãƒ©ãƒ³ãƒã§å®Ÿè¡Œ
# - ãƒ‡ãƒ—ãƒ­ã‚¤: main, master, develop ãƒ–ãƒ©ãƒ³ãƒ + PR ã®ã¿ï¼ˆå°†æ¥å®Ÿè£…äºˆå®šï¼‰

on:
  push:
    branches: [ '**' ]  # ã™ã¹ã¦ã®ãƒ–ãƒ©ãƒ³ãƒã§ãƒ†ã‚¹ãƒˆãƒ»ãƒªãƒ³ãƒˆã‚’å®Ÿè¡Œ
  pull_request:
    branches: [ '**' ]  # ã™ã¹ã¦ã®ãƒ–ãƒ©ãƒ³ãƒã«å¯¾ã™ã‚‹PRã§ãƒ†ã‚¹ãƒˆãƒ»ãƒªãƒ³ãƒˆã‚’å®Ÿè¡Œ

env:
  GO_VERSION: '1.24.5'

jobs:
  # ãƒ“ãƒ«ãƒ‰ã¨Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ä½œæˆï¼ˆå…¨ã‚¸ãƒ§ãƒ–ã®åŸºç›¤ï¼‰
  build:
    name: Build
    runs-on: ubuntu-latest
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Install dependencies
      run: go mod download

    - name: Verify dependencies
      run: go mod verify

    - name: Build application
      run: |
        mkdir -p bin
        go build -v -o bin/memo-app src/main.go

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: memo-app-binary
        path: bin/memo-app

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and export Docker image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        dockerfile: |
          FROM golang:1.24.5-alpine AS test
          RUN apk --no-cache add git ca-certificates tzdata wget curl make bash
          WORKDIR /app
          COPY . .
          RUN go mod download
          ENV DOCKER_CONTAINER=true
          ENV GIN_MODE=test
          RUN mkdir -p /app/logs
          EXPOSE 8080
          CMD ["tail", "-f", "/dev/null"]
          
          FROM golang:1.24.5-alpine AS builder
          WORKDIR /app
          COPY . .
          RUN go mod download
          RUN CGO_ENABLED=0 GOOS=linux go build -o memo-app src/main.go
          
          FROM alpine:3.19 AS production
          RUN apk --no-cache add ca-certificates tzdata
          WORKDIR /app
          COPY --from=builder /app/memo-app .
          RUN chmod +x ./memo-app
          ENV DOCKER_CONTAINER=true
          EXPOSE 8080
          CMD ["./memo-app"]
        target: test
        push: false
        tags: memo-app:latest
        outputs: type=docker,dest=/tmp/memo-app.tar
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Upload Docker image
      uses: actions/upload-artifact@v4
      with:
        name: memo-app-docker
        path: /tmp/memo-app.tar

  # ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã¨çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆãƒ“ãƒ«ãƒ‰å¾Œã«å®Ÿè¡Œï¼‰
  test:
    name: Tests
    runs-on: ubuntu-latest
    needs: build
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: memo_db
          POSTGRES_USER: memo_user
          POSTGRES_PASSWORD: memo_password
        ports:
          - 5433:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Download Docker image
      uses: actions/download-artifact@v4
      with:
        name: memo-app-docker
        path: /tmp/

    - name: Load Docker image
      run: |
        docker load --input /tmp/memo-app.tar
        docker image ls -a

    - name: Install PostgreSQL client
      run: |
        sudo apt-get update
        sudo apt-get install -y postgresql-client

    - name: Wait for PostgreSQL
      run: |
        echo "PostgreSQLã‚µãƒ¼ãƒ“ã‚¹ã®èµ·å‹•ã‚’å¾…æ©Ÿä¸­..."
        for i in {1..30}; do
          if PGPASSWORD=memo_password psql -h localhost -p 5433 -U memo_user -d memo_db -c "SELECT 1;" > /dev/null 2>&1; then
            echo "PostgreSQLã‚µãƒ¼ãƒ“ã‚¹ãŒåˆ©ç”¨å¯èƒ½ã§ã™"
            break
          fi
          echo "å¾…æ©Ÿä¸­... ($i/30)"
          sleep 2
        done

    - name: Initialize database
      run: |
        echo "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åˆæœŸåŒ–ä¸­..."
        # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åˆæœŸåŒ–
        PGPASSWORD=memo_password ./scripts/migrate-database.sh \
          --host localhost \
          --port 5433 \
          --username memo_user \
          --database memo_db \
          --both \
          --verbose
        echo "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–å®Œäº†"

    - name: Run tests in Docker container
      run: |
        # Dockerã‚³ãƒ³ãƒ†ãƒŠå†…ã§ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        docker run --rm \
          --network host \
          -e TEST_DATABASE_URL="postgres://memo_user:memo_password@localhost:5433/memo_db?sslmode=disable" \
          -e COVERAGE=true \
          -e VERBOSE=true \
          memo-app:latest \
          sh -c "go test ./test/config ./test/middleware ./test/logger ./test/storage -v -cover"

    - name: Run integration tests in Docker container
      run: |
        docker run --rm \
          --network host \
          -e VERBOSE=true \
          memo-app:latest \
          sh -c "go test ./test/integration -v"

    - name: Run API tests in Docker container
      run: |
        docker run --rm \
          --network host \
          -e VERBOSE=true \
          memo-app:latest \
          sh -c "go test ./test -v"

    - name: Run database tests in Docker container
      run: |
        # ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ç¢ºèªã¨åˆæœŸåŒ–
        PGPASSWORD=memo_password psql -h localhost -p 5433 -U memo_user -d memo_db_test -c "SELECT 1;" || {
          echo "ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†å®Ÿè¡Œã—ã¾ã™ã€‚"
          PGPASSWORD=memo_password ./scripts/migrate-database.sh \
            --host localhost \
            --port 5433 \
            --username memo_user \
            --database memo_db \
            --test-db \
            --verbose
        }
        # Dockerã‚³ãƒ³ãƒ†ãƒŠå†…ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        docker run --rm \
          --network host \
          -e TEST_DATABASE_URL="postgres://memo_user:memo_password@localhost:5433/memo_db_test?sslmode=disable" \
          -e VERBOSE=true \
          memo-app:latest \
          sh -c "go test ./test/database -v"

    - name: Generate coverage report in Docker container
      run: |
        # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
        mkdir -p /tmp/coverage
        
        # Dockerã‚³ãƒ³ãƒ†ãƒŠå†…ã§å…¨ãƒ†ã‚¹ãƒˆã®ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ç”Ÿæˆ
        docker run --rm \
          --network host \
          -v /tmp/coverage:/tmp/coverage \
          -e TEST_DATABASE_URL="postgres://memo_user:memo_password@localhost:5433/memo_db_test?sslmode=disable" \
          memo-app:latest \
          sh -c "go test ./test/... -v -cover -coverprofile=/tmp/coverage/coverage.out && go tool cover -html=/tmp/coverage/coverage.out -o /tmp/coverage/coverage.html"
        
        # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ›ã‚¹ãƒˆã«ã‚³ãƒ”ãƒ¼
        cp /tmp/coverage/coverage.out ./coverage.out || echo "coverage.out not found"
        cp /tmp/coverage/coverage.html ./coverage.html || echo "coverage.html not found"

    - name: Upload coverage reports
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.out
        flags: unittests
        name: codecov-umbrella

  # Linting and formattingï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãªãƒ›ã‚¹ãƒˆç’°å¢ƒå®Ÿè¡Œï¼‰
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Install dependencies
      run: go mod download

    - name: Run CI lint checks
      run: |
        echo "ğŸ” CIç”¨ãƒªãƒ³ãƒˆã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™..."
        
        echo "ğŸ“ go fmt ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
        unformatted_files=$(gofmt -l .)
        if [ -n "$unformatted_files" ]; then
          echo "âŒ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã™:"
          echo "$unformatted_files"
          echo "ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ä¿®æ­£ã—ã¦ãã ã•ã„: go fmt ./..."
          exit 1
        else
          echo "âœ… go fmt ãƒã‚§ãƒƒã‚¯å®Œäº†"
        fi
        
        echo "ğŸ“ go vet ã‚’å®Ÿè¡Œä¸­..."
        go vet ./...
        echo "âœ… go vet å®Œäº†"
        
        echo "ğŸ“ go mod verify ã‚’å®Ÿè¡Œä¸­..."
        go mod verify
        echo "âœ… go mod verify å®Œäº†"
        
        echo "ğŸ“ go mod tidy ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
        cp go.mod go.mod.bak
        cp go.sum go.sum.bak
        go mod tidy
        if ! diff go.mod go.mod.bak >/dev/null || ! diff go.sum go.sum.bak >/dev/null; then
          echo "âŒ go.mod ã¾ãŸã¯ go.sum ãŒæœ€æ–°ã§ã¯ã‚ã‚Šã¾ã›ã‚“"
          echo "ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ä¿®æ­£ã—ã¦ãã ã•ã„: go mod tidy"
          rm -f go.mod.bak go.sum.bak
          exit 1
        else
          echo "âœ… go mod tidy ãƒã‚§ãƒƒã‚¯å®Œäº†"
          rm -f go.mod.bak go.sum.bak
        fi
        
        echo "ğŸ‰ CIç”¨ãƒªãƒ³ãƒˆå®Œäº†"

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆãƒ“ãƒ«ãƒ‰å¾Œã«å®Ÿè¡Œï¼‰
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Install dependencies
      run: go mod download

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: memo-app-binary
        path: bin/

    - name: Run Security Scan
      run: make security-ci

  # E2Eãƒ†ã‚¹ãƒˆï¼ˆDockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨ï¼‰
  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Download Docker image
      uses: actions/download-artifact@v4
      with:
        name: memo-app-docker
        path: /tmp/

    - name: Load Docker image
      run: |
        docker load --input /tmp/memo-app.tar
        docker image ls -a

    - name: Start services with Docker Compose
      run: |
        # CIç”¨Docker Composeã§ã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹•ï¼ˆãƒ“ãƒ«ãƒ‰æ¸ˆã¿ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨ï¼‰
        docker compose -f docker-compose.ci.yml up -d
        
        # ã‚µãƒ¼ãƒ“ã‚¹ãŒèµ·å‹•ã™ã‚‹ã¾ã§å¾…æ©Ÿ
        echo "ã‚µãƒ¼ãƒ“ã‚¹ã®èµ·å‹•ã‚’å¾…æ©Ÿä¸­..."
        
        # PostgreSQLãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚‹ã¾ã§å¾…æ©Ÿ
        echo "PostgreSQLã®èµ·å‹•ç¢ºèªä¸­..."
        for i in {1..30}; do
          if docker compose -f docker-compose.ci.yml exec -T db pg_isready -U memo_user -d memo_db > /dev/null 2>&1; then
            echo "PostgreSQL ready"
            break
          fi
          echo "PostgreSQL waiting... ($i/30)"
          sleep 2
        done
        
        # MinIOãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚‹ã¾ã§å¾…æ©Ÿ
        echo "MinIOã®èµ·å‹•ç¢ºèªä¸­..."
        for i in {1..30}; do
          if curl -f http://localhost:9000/minio/health/live > /dev/null 2>&1; then
            echo "MinIO ready"
            break
          fi
          echo "MinIO waiting... ($i/30)"
          sleep 2
        done
        
        # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚‹ã¾ã§å¾…æ©Ÿ
        echo "ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•ç¢ºèªä¸­..."
        for i in {1..60}; do
          if curl -f http://localhost:8080/health > /dev/null 2>&1; then
            echo "Application ready"
            break
          fi
          echo "Application waiting... ($i/60)"
          sleep 2
        done
        
        echo "å…¨ã‚µãƒ¼ãƒ“ã‚¹ã®èµ·å‹•å®Œäº†"

    - name: Check service status and logs
      run: |
        echo "=== ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ç¢ºèª ==="
        docker compose -f docker-compose.ci.yml ps
        
        echo "=== ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚° ==="
        docker compose -f docker-compose.ci.yml logs app
        
        echo "=== ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ­ã‚° ==="
        docker compose -f docker-compose.ci.yml logs db
        
        echo "=== ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯çµæœ ==="
        curl -v http://localhost:8080/health || echo "Health check failed"

    - name: Run E2E tests
      run: |
        # CIç’°å¢ƒã§ã‚ã‚‹ã“ã¨ã‚’é€šçŸ¥
        export CI_ENVIRONMENT=true
        export E2E_SKIP_COMPOSE_SETUP=true
        
        # E2Eãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        go test ./test/e2e -v -timeout=10m

    - name: Stop services
      if: always()
      run: docker compose -f docker-compose.ci.yml down -v
